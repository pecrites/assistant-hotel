<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Assistant H√¥tel ‚Äì Client</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
    font-family: Arial, sans-serif;
    background: #0b1f3a;
    color: white;
    margin: 0;
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
}
.container {
    text-align: center;
    width: 90%;
    max-width: 400px;
}
h1 {
    margin-bottom: 30px;
}
button {
    width: 100%;
    padding: 25px;
    font-size: 22px;
    border-radius: 50px;
    border: none;
    background: #ffcc33;
    color: #000;
    cursor: pointer;
    margin-bottom: 20px;
}
button:active {
    background: #ffb300;
}
textarea, input {
    width: 100%;
    padding: 12px;
    margin-top: 10px;
    border-radius: 8px;
    border: none;
    font-size: 16px;
}
.small {
    font-size: 12px;
    opacity: 0.85;
    margin-top: 10px;
}
</style>
</head>

<body>

<div class="container">
    <h1>üé§ Parlez √† la r√©ception</h1>

    <!-- BOUTON VOCAL PRINCIPAL -->
    <button onclick="startVoice()">üéôÔ∏è APPUYER POUR PARLER</button>

    <!-- TEXTE (OPTIONNEL) -->
    <textarea id="text" rows="3" placeholder="Ou √©crivez votre demande (optionnel)"></textarea>

    <!-- CHAMBRE (OBLIGATOIRE) -->
    <input id="room" placeholder="Num√©ro de chambre (ex : 203)" />

    <button onclick="sendText()">üì® Envoyer</button>

    <p class="small">
        Votre demande est transmise imm√©diatement √† la r√©ception
    </p>
</div>

<script>
let recognition;
let stopTimer;

// ==========================
// üîä RETOUR VOCAL (CONFIRMATION)
// ==========================
function speakConfirmation() {
    if (!("speechSynthesis" in window)) return;

    const message = new SpeechSynthesisUtterance(
        "Votre demande a bien √©t√© transmise √† la r√©ception."
    );
    message.lang = "fr-FR";
    message.rate = 1;
    message.pitch = 1;

    window.speechSynthesis.cancel();
    window.speechSynthesis.speak(message);
}

// ==========================
// üé§ RECONNAISSANCE VOCALE
// ==========================
function startVoice() {
    if (!("webkitSpeechRecognition" in window)) {
        alert("La reconnaissance vocale n‚Äôest pas support√©e sur ce navigateur.");
        return;
    }

    recognition = new webkitSpeechRecognition();
    recognition.lang = "fr-FR";
    recognition.continuous = false;
    recognition.interimResults = false;

    recognition.onstart = () => {
        // S√©curit√© : arr√™t automatique apr√®s 6 secondes
        stopTimer = setTimeout(() => {
            recognition.stop();
        }, 6000);
    };

    recognition.onresult = (event) => {
        clearTimeout(stopTimer);
        const text = event.results[0][0].transcript;
        document.getElementById("text").value = text;
        recognition.stop();

        // ‚ö†Ô∏è IMPORTANT : retour vocal AVANT le fetch
        speakConfirmation();
        sendText(true);
    };

    recognition.onerror = () => {
        clearTimeout(stopTimer);
        recognition.stop();
        alert("Erreur de reconnaissance vocale. R√©essayez.");
    };

    recognition.start();
}

// ==========================
// üì§ ENVOI AU SERVEUR
// ==========================
async function sendText(fromVoice = false) {
    const text = document.getElementById("text").value.trim();
    const room = document.getElementById("room").value.trim();

    // üö´ Chambre obligatoire
    if (!room) {
        alert("Veuillez entrer votre num√©ro de chambre.");
        return;
    }

    // üö´ Texte obligatoire
    if (!text) {
        alert("Parlez ou √©crivez votre demande.");
        return;
    }

    // üîä Si envoi manuel (clic), on parle ici
    if (!fromVoice) {
        speakConfirmation();
    }

    await fetch("/api/send", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            room: room,
            text: text,
            lang: "fr"
        })
    });

    document.getElementById("text").value = "";
}
</script>

</body>
</html>
